<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Quản lý bài viết</title>
    <th:context th:replace="base :: resources"></th:context>
</head>
<body>
    <div th:replace="~{index :: header}"></div>

    <div class="container mt-4">
        <h2 th:text="${post.id != null} ? 'Cập nhật bài viết' : 'Tạo bài viết mới'"></h2>
        
        <!-- Form tạo hoặc cập nhật bài viết -->
        <form th:action="@{${post.id != null} ? '/post/' + ${post.id} : '/post'}"
              th:object="${post}" method="post">
            <div class="mb-3">
                <label for="content" class="form-label">Nội dung</label>
                <textarea class="form-control" id="content" th:field="*{content}" rows="3" required></textarea>
                <div class="text-danger" th:errors="*{content}"></div>
            </div>
            <button type="submit" class="btn btn-primary">
                <span th:text="${post.id != null} ? 'Cập nhật' : 'Tạo mới'"></span>
            </button>
        </form>

        <hr/>

        <!-- Danh sách bài viết -->
        <h3>Danh sách bài viết</h3>
        <table class="table table-bordered table-hover">
            <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>Nội dung</th>
                    <th>Người đăng</th>
                    <th>Số bình luận</th>
                    <th>Thống kê cảm xúc</th>
                    <th>Khoá comment</th>
                    <th>Hành động</th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="p : ${posts}">
                    <td th:text="${p.id}"></td>
                    <td th:text="${p.content}"></td>
                    <td th:text="${p.user.fullName} ?: 'Ẩn danh'"></td>
                    <td th:text="${p.commentCount} ?: 0"></td>
                    <td>
                        <span th:each="entry : ${p.reactionStats}">
                            <span th:text="${entry.key + ': ' + entry.value}"></span><br/>
                        </span>
                    </td>
                    <td>
                        <form th:action="@{'/post/' + ${p.id} + '/lock-comments'}" method="post">
                            <input type="hidden" name="lock" th:value="${!p.isCommentLocked}" />
                            <button class="btn btn-sm" th:classappend="${p.isCommentLocked} ? 'btn-warning' : 'btn-success'" type="submit">
                                <span th:text="${p.isCommentLocked} ? 'Mở' : 'Khoá'"></span>
                            </button>
                        </form>
                    </td>
                    <td>
                        <a th:href="@{'/post/' + ${p.id}}" class="btn btn-sm btn-primary">Sửa</a>
                        <a th:href="@{'/post/delete/' + ${p.id}}" class="btn btn-sm btn-danger"
                           onclick="return confirm('Bạn chắc chắn muốn xoá?')">Xoá</a>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <div th:replace="~{base :: footer}"></div>
</body>
</html>